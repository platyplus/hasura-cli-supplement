# Rationale

Recurrent patterns are present in databases and areas currently covered by Hasura, for example authentication, sending of emails, soft delete, monetisation, storage rules, audit trail...
Whereas not all the business logic of such modules cannot sometimes be embbeded inside an Hasura instance, Hasura can be of great help to ease their implementation, through pieces of metadata and SQL schema.

## Related

- [RFC: Community library of data models, postgres functions and constraints for the console](https://github.com/hasura/graphql-engine/issues/4180)

# Features

A module is a set of sql migrations and metadata that can be installed, upgraded and uninstalled with predictable or no side-effects on an existing database managed by Hasura.

## Installation

The module installation should run series of sql migrations initially generated by the Hasura console, in either config v1 or config v2:

`hasura modules install <module-name>`

## Upgrade

`hasura modules upgrade <module-name>`
Modules should be able to be upgraded, meaning the underlying sql design elements can be altered or dropped, and new ones can be created.

The module metadata metadata should be upgradable too, which implies an incremental metadata system that exists in Hasura console config v1, but not anymore on config v2.

## Uninstallation

Unintall a module i.e. its Postgres structure and hasura metadata:

`hasura modules uninstall <module-name>`

As the developer using a module may want to keep the data that would have been handled through the module, an option should be available so only metadata is removed, not sql elements such as tables etc:

`hasura modules uninstall <module-name> --only-metadata`

Some sql or metadata elements may become essential to the functionning of the application event when the module is uninstalled, for instance a `user` table in an authentication module, that is most likely going to be re-used in the rest of the applicaiton.

Modules should be able to define such a distinction between 'core' and 'nnon-core' sql or metadata elements so the developper can decide to keep the elements that would stay in the database:

`hasura modules uninstall <module-name> --only-core`

## Inconsistencies & safety

`hasura modules status <module-name>`

`hasura modules repare <module-name>`

"dry run"

## Public repository

### List

`hasura modules list`

### Module information

`hasura modules show <module-name>`

<!-- ## Contributions -->
<!-- TODO standard / third-party modules -->

# Examples

## Embedded Module

Some modules won't need any external service to be fully functionnal with Postgres and Hasura.

Let's imagine quickly a set of SQL functions, triggers and views that allow to alter the tables to implement a soft delete system. Some functions could be mapped as Hasura metadata so an admin user can add soft deletion to a given table. Soft deleted records would be moved to a dedicated table with their values stored as JSONB.
Another function would be available to undo a deletion.

_(Note: this way is not necessarily the best to implement soft deletion, and is described as a means to illustrate this RFC.)_

### Installation

The installation proceedings would be:

- Ensure Hasura is running correctly and that the project `config.yaml` is correctly configured
- `hasura modules install soft-delete`
  - This command would run SQL migrations that create the necessary tables, functions, etc in a dedicated `soft_delete` Postgres schema, and add the corresponding operations to the existing Hasura metadata.
  - The corresponding SQL migrations would be added to the `migrations` directory
  - The corresponding Hasura metadata would be added to the `metadata` directory if using config v2.

### Upgrade

Let's say a new version of the `soft-delete` is available. It contains new SQL migrations as well as a diff of the metadata. The developer can then upgrade the module with `hasura modules upgrade soft-delete`

### Uninstall

The command would be `hasura modules uninstall soft-delete`.

The developer could choose not to remove the sql tables and functions for some reasong with `hasura modules uninstall --only-metadata`. It would in that case update only the Hasura metadata.

## Microservice Module

Let's imagine now a module that allows the sending of email through an external email service, the tracking of the mails sent by users, the ability to define templates... This module would require some tables, relationships and most likely event triggers or actions.

It would also require additional steps to follow one a module is installed, e.g.:

- Create an account, fetch some credentials like an access token...
- For a self-hosted microservice, for instance a docker container, pull, configure and run a docker image.
- Add environment variables to Hasura, and restart the server to take them into account

All the above steps are hardly automatisable. However, a module should be able to print an explanation of the next steps forward, following its installation. For example, an Hasura action is internally defined with the url `{{EMAIL_SERVICE_URL}}/send-email`, and would require an account id `EMAIL_SERVICE_ACCOUNT_ID` and an access token `EMAIL_SERVICE_ACCOUNT_TOKEN` variable that would be sent to the handler as header. The post-install text would be:

```
In order to activate the module, you should add the following environment variables in your Hasura GraphQL Engine server:
EMAIL_SERVICE_URL=https://hasura-emailer.io
EMAIL_SERVICE_ACCOUNT_ID=<your hasura emailer account id>
EMAIL_SERVICE_ACCOUNT_TOKEN=<your hasura emailer account token>

For further information, please visit https://docs.hasura-emailer.io
```

# Proceedings

## Interface

Initially the Hasura modules would be available through the Hasura CLI, but the inclusion of the following features to the console is to be considered.

## Keep track of the SQL migrations and Hasura metadata

## Incremental metadata

## Core and Non-Core SQL/metadata

## Dependencies between modules

## Module Directory Structure

# Priorisitaion

Following MoSCoW:

- Must
  1. install
  2. list
  3. uninstall
  4. upgrade
  - Compatibility with both config v1 and config v2
- Should
  - User Interface through the console
  - standard / third-party modules
- Could
  - core/non-core metadata/sql design elements
  - Uninstall only metadata
- Won't

# Proof of Concept

[A proof of concept is under way here](https://github.com/platyplus/hasura-modules)
